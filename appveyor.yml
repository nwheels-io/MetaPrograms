version: 0.1.0-{build}-{branch}-ci

image: ubuntu

configuration: Release

install:
- cd Source && dotnet restore

build:
  project: Source/MetaPrograms.sln
  verbosity: minimal
  publish_nuget: true

dotnet_csproj:
  patch: true
  file: '**\*.csproj'
  version: '{version}'

test_script:
- cd Source && for PROJECT in $(find . -type d -name '*Tests' | cut -c3-); do \
    DLL=./$PROJECT/bin/Release/netcoreapp2.0/$PROJECT.dll; \
    echo "--- $PROJECT ---"; \
    dotnet test $PROJECT /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=./$PROJECT.opencover.xml ; \
    done
